#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/wait.h>
#include <time.h>

static void child(unsigned long [], unsigned long);

void scheduler(char* input, char* outfile, int limit, int total){
	int increment = 0, i = 0, k, status, alive = 1, noChildFlag = 1;
	unsigned long nanoSec, life, shmID, seconds = 10000;
	unsigned long * shmPTR;
	pid_t pid[total], endID = 1;
	time_t when, when2;
	FILE * fp;
	time(&when);
	fp = fopen(input, "r");
	//Check for file error.
	if (fp == NULL){
		perror("Error");
		printf("File given: %s, error number: %d\n", input, errno);
		printf("No output generated.\n");
	}
	fscanf(fp, "%d", &increment);
	shmID = shmget(IPC_PRIVATE, sizeof(unsigned long), IPC_CREAT | IPC_EXCL | 0777);
	shmPTR = (unsigned long *) shmat(shmID, NULL, 0);
	shmPTR[0] = 0;
	for(k = 0; k < total; k++){
		pid[k] = -1;
	}
	while(alive > 0){
		time(&when2);
//		if ((when2 - when) >= 1){
//			printf("Program has exceeded its allotted time, exiting.\n");
//			shmdt(shmPTR);
//			wait(NULL);
//			exit(EXIT_SUCCESS);
//		}
		if (seconds > 1000){
			if (fscanf(fp, "%d", &seconds) !=EOF){
				fscanf(fp, "%li", &nanoSec);
				fscanf(fp, "%li", &life);
//				printf("New child time values. %li : %li\n", seconds, nanoSec);
			}
		}
		shmPTR[0] += increment;
		if(shmPTR[0] >= ((seconds * 1000000000) + nanoSec)){
			//printf("%d:", seconds);
			//printf(" %li\n", nanoSec);
			//printf("Timer: %li\n", shmPTR[0]);
			if((pid[i] = fork()) == 0){
				child(shmPTR, life);
				exit(EXIT_SUCCESS);
			}
			else{
				printf("Child %d spawned.\n", pid[i]);
				if (noChildFlag > 0){
					alive--;
					noChildFlag = 0;
				}
				seconds = 10000;
				nanoSec = 0;
				life = 0;
				alive++;
				i++;
			}
		}
		endID = waitpid(0, &status, WNOHANG | WUNTRACED);
		if (endID == -1){
//			perror("waitpid error");
		}
		else if (endID == 0);
		else{
			for(k = 0; k <= i; k++){
				if(endID == pid[k]){
					alive--;
					if (alive > 0){
						if (WIFEXITED(status)){
							printf("Child ended normally.\n");
						}
						else if (WIFSIGNALED(status)){
							printf("Child ended with an uncaught signal.\n");
						}
						else if (WIFSTOPPED(status)){
							printf("Child process has stopped.\n");
						}
					}
				}
			}
		}
		if (alive > total){
			printf("Program has exceeded its allotted time, exiting.\n");
			shmdt(shmPTR);
			wait(NULL);
			exit(EXIT_SUCCESS);
		}
	}
	printf("Timer: %li\n", shmPTR[0]);
	shmdt(shmPTR);
}


void child(unsigned long sharedMem[], unsigned long life){
	unsigned long existence;
	pid_t pid = getpid();
//	printf("Child entered at %li with life %li.\n", sharedMem[0], life);
	existence = sharedMem[0] + life;
//	printf("Exists until %li.\n", existence);
	while(sharedMem[0] < existence);
	printf("Child exiting at %li.\n", sharedMem[0]);
	shmdt(sharedMem);
//	kill(pid, SIGKILL);
	_exit(EXIT_SUCCESS);
}
